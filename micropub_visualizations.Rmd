---
title: "Cold tolerance micropub analysis and visulaizations"
author: "Amanda Peake"
date: "2025-07-25"
output: html_document
editor_options: 
  chunk_output_type: console
---

## R version and packages needed
```{r, include=FALSE}
R.Version()$version.string

library(tidyverse)
library(ggplot2)
library(agricolae)
library(lme4)
library(lmerTest)
library(dplyr)
library(ggpubr)
library(gridExtra)
library(cowplot)

```
Note: checked that all warning msgs for "package <...> was built under R version <...>" are backwards compatible with current R version (4.4.0) according to packageDescription(). 


## Import data
```{r}
#12 hour cold treatment
cold12hrs_delta_df <- read.csv("C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/12hours_manuscript_df.csv", header=TRUE)

#24 hour cold treatment
cold24hrs_delta_df <- read.csv("C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/24hours_manuscript_df.csv", header=TRUE)
```


## Make functions

Change some dataframe columns from being human readable to be more machine friendly

```{r}
format_colnames <- function(dataframe) { 
  dataframe %>% 
  dplyr::rename(Well_id = well.ID, 
                Plate_design = Plate.Design, 
                Well_strain = Well.Strain, 
                mean_wormlength_um = Mean.wormlength..µm.,
                min_wormlength_um = Minimum.wormlength..µm., 
                q10_wormlength_um = q10.wormlength..µm., 
                q25_wormlength_um = q25.wormlength..µm., 
                median_wormlength_um = Median.wormlength..µm., 
                sd_wormlength_um = Standard.Deviation.wormlength..µm., 
                q75_wormlength_um = q75.wormlength..µm., 
                q90_wormlength_um = q90.wormlength..µm., 
                max_wormlength_um = Maximum.wormlength..µm.,
                cv_wormlength_um = Coefficient.of.variation.wormlength..µm., 
                n = Number.of.worms, 
                control_median_wormlength_um = Control.median.wormlength..µm., 
                median_wormlength_um_delta = Delta.median.wormlength..µm.
  )
}

```

Get rank order delta values
```{r}
rank_order_delta <- function(dataframe) {
  dataframe  %>% 
    dplyr::filter(Treatment == "treatment") %>% 
    dplyr::group_by(Strain) %>% 
    dplyr::summarise(
      delta_mean = mean(median_wormlength_um_delta, na.rm = TRUE), 
      delta_median = median(median_wormlength_um_delta, na.rm = TRUE)) %>% 
    dplyr::arrange(delta_mean)
}
```

Get rank order control values
```{r}
rank_order_control <- function(dataframe) {
  dataframe  %>% 
    dplyr::filter(Treatment == "control") %>% 
    dplyr::group_by(Strain) %>% 
    dplyr::summarise(
      control_mean = mean(median_wormlength_um, na.rm = TRUE), 
      control_median = median(median_wormlength_um, na.rm = TRUE)) %>% 
    dplyr::arrange(control_mean)
}
```




## Get values for results section

Format column names
```{r}
cold12hrs_delta_df <- format_colnames(cold12hrs_delta_df)
cold24hrs_delta_df <- format_colnames(cold24hrs_delta_df)
```


Rank order of delta
```{r}
#12 hours
rank_delta_12hrs <- rank_order_delta(cold12hrs_delta_df)
rank_delta_12hrs

#24 hours
rank_delta_24hrs <- rank_order_delta(cold24hrs_delta_df)
rank_delta_24hrs

```


Rank order of control
```{r}
#12 hours
rank_control_12hrs <- rank_order_control(cold12hrs_delta_df)
rank_control_12hrs

#24 hours
rank_control_24hrs <- rank_order_control(cold24hrs_delta_df)
rank_control_24hrs
```


Run a spearman rank correlation for control length vs treatment delta. 
```{r}
#Make correlation test dataframes
cor_12hrs_df <- merge(rank_control_12hrs, rank_delta_12hrs, by = "Strain")
cor_24hrs_df <- merge(rank_control_24hrs, rank_delta_24hrs, by = "Strain")
###cor_1wk_df <- merge(rank_control_1wk, rank_delta_1wk, by = "Strain")

#12 hours - correlation and scatter plot
cor.test(cor_12hrs_df$control_mean, cor_12hrs_df$delta_mean, method = "spearman")
cor.test(cor_12hrs_df$control_mean, cor_12hrs_df$delta_mean, method = "pearson")

#24 hours - correlation and scatter plot
cor.test(cor_24hrs_df$control_mean, cor_24hrs_df$delta_mean, method = "spearman")
cor.test(cor_24hrs_df$control_mean, cor_24hrs_df$delta_mean, method = "pearson")
```


## 12 hour cold treatment

Linear model to check for differences in length between treatment groups and strains
```{r}
#make sure all categorical variables that will be in the model are factors
cold12hrs_delta_df$Plate_design <- as.factor(cold12hrs_delta_df$Plate_design)
cold12hrs_delta_df$Treatment <- as.factor(cold12hrs_delta_df$Treatment)
cold12hrs_delta_df$Strain <- as.factor(cold12hrs_delta_df$Strain)

#Run linear model to see if treatment is significant
lm_12hrs <- lmerTest::lmer(median_wormlength_um ~ Plate_design + Treatment + (1|Strain) + (1|Strain:Treatment), data = cold12hrs_delta_df)
summary(lm_12hrs)
anova(lm_12hrs)

#Likelihood ratio test to see if strain and strain*treatment terms are significant
lrt_12hrs <- lmerTest::ranova(lm_12hrs)
lrt_12hrs

#Adjust p-values by dividing by 2 because when testing the effect of a random effect the null model has a variance of 0. 
lrt_12hrs_strain_padj <- (lrt_12hrs$`Pr(>Chisq)`[2])/2
lrt_12hrs_strain_padj

lrt_12hrs_strain_treatment_padj <- (lrt_12hrs$`Pr(>Chisq)`[3])/2
lrt_12hrs_strain_treatment_padj

#Calculate heritability 
vc_12hrs <- as.data.frame(lme4::VarCorr(lm_12hrs), comp = c("Variance"))
strain_treatment_variance_12hrs <- vc_12hrs$vcov[vc_12hrs$grp == "Strain:Treatment"]
strain_variance_12hrs <- vc_12hrs$vcov[vc_12hrs$grp == "Strain"]
residual_variance_12hrs <- vc_12hrs$vcov[vc_12hrs$grp == "Residual"]

H2_strain_12hrs <- strain_variance_12hrs/(strain_variance_12hrs + residual_variance_12hrs + strain_treatment_variance_12hrs)
H2_strain_12hrs

H2_strain_treatment_12hrs <- strain_treatment_variance_12hrs/(strain_variance_12hrs + residual_variance_12hrs + strain_treatment_variance_12hrs)
H2_strain_treatment_12hrs
```


Delta anova and box plot
```{r}
#Make treatement dataframe
treatment12hrs_df <- cold12hrs_delta_df %>%
  dplyr::filter(Treatment == "treatment")


#Make box plot
treatment12_delta_plot <- ggplot(treatment12hrs_df, aes(x = Strain, y = median_wormlength_um_delta)) + 
  ggplot2::geom_boxplot(outlier.shape = NA) +
  ggplot2::geom_jitter(shape=16, position=position_jitter(0.2), size = 1, alpha = 0.5) + 
  ggplot2::xlab("Strain") + 
  ggplot2::ylab("Treatment - Control\nAnimal Length (µm)") +
  ggplot2::theme_classic() + 
  ggplot2::theme(
    axis.title.y = element_text(size = 10), 
    axis.title.x = element_text(size = 10), 
    axis.text.x = element_text(size = 8)
  ) + 
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0.05, 0.1)))
treatment12_delta_plot 
```


Rxn norm for length
```{r}
#create strain mean dataframe
rxn_df_12hrs <- cold12hrs_delta_df %>% 
  dplyr::select(Treatment, Strain, median_wormlength_um) %>%
  dplyr::group_by(Strain, Treatment) %>% 
    dplyr::summarise(
      wormlength_strain_mean = mean(median_wormlength_um, na.rm = TRUE)) %>% 
  dplyr::mutate(contidition_numeric = case_when(
    Treatment == "control" ~ 1, 
    Treatment == "treatment" ~ 2
  ))

#Create heritabiliity dataframes so that heritability can be added to plots
H2_strain_12hrs_plot_df <- data.frame(
  x = 1.5,
  y = max(rxn_df_12hrs$wormlength_strain_mean) + 40,
  label = I(list(bquote(italic({H^2}[strain]) == .(round(H2_strain_12hrs, digits = 2))))))

H2_strain_treatment_12hrs_plot_df <- data.frame(
  x = 1.5,
  y = max(rxn_df_12hrs$wormlength_strain_mean) + 20,
  label = I(list(bquote(italic({H^2}[strain~":"~treatment]) == .(round(H2_strain_treatment_12hrs, digits = 2))))))


#make rxn norm plot
rxn_plot_12hrs <- ggplot(rxn_df_12hrs, aes(x = contidition_numeric, y=wormlength_strain_mean)) + 
  ggplot2::geom_line(aes(group=Strain)) + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_continuous(breaks = c(1,2), 
                     limits = c(1,2), 
                     labels = c("20°C", "4°C")) + 
  ggplot2::geom_text(data = H2_strain_12hrs_plot_df, 
            aes(x = x, y = y, label = label), 
            parse = TRUE, 
            size = 3.5)  + 
  ggplot2::geom_text(data = H2_strain_treatment_12hrs_plot_df, 
            aes(x = x, y = y, label = label), 
            parse = TRUE, 
            size = 3.5)  + 
  ggplot2::xlab("L1 Larval Stage Temperature") + 
  ggplot2::ylab("Mean Animal Length (µm)") +
  ggplot2::theme_classic() + 
  ggplot2::theme(
    axis.title.y = element_text(size = 10), 
    axis.title.x = element_text(size = 10), 
    axis.text.x = element_text(size = 8)
  )

rxn_plot_12hrs
```


merge 12 hour plots together to make panel
```{r}
Fig1_panelA <- cowplot::plot_grid(treatment12_delta_plot + 
                                    ggplot2::theme(axis.title.x = element_blank(), 
                                                   axis.text.x = element_blank(), 
                                                   plot.margin = margin(b = 0.7, t= 0.25, l = 0.2, r =0.25, unit = "cm")
                                          ),
                                  rxn_plot_12hrs + 
                                    ggplot2::theme(axis.title.x =  element_blank(), 
                                                   plot.margin = margin(b = 0.7, t= 0.25, l = 0.2, r =0.25, unit = "cm")) + 
                                    ggplot2::scale_x_continuous(breaks = c(1,2),
                                                                limits = c(1,2), 
                                                                labels = NULL), 
                                  rel_widths = c(3, 2))

Fig1_panelA <- cowplot::ggdraw(Fig1_panelA) + cowplot::draw_label("12-hour cold treatment", 
                                                fontface = 'bold', 
                                                x = 0.5, 
                                                y = 0.95, 
                                                size = 12)

Fig1_panelA
```



## 24 hour cold treatment
Linear model to check for differences in length between treatment groups and strains
```{r}
#make sure all categorical variables that will be in the model are factors
cold24hrs_delta_df$Plate_design <- as.factor(cold24hrs_delta_df$Plate_design)
cold24hrs_delta_df$Treatment <- as.factor(cold24hrs_delta_df$Treatment)
cold24hrs_delta_df$Strain <- as.factor(cold24hrs_delta_df$Strain)

#Run linear model to see if treatment is significant
lm_24hrs <- lmerTest::lmer(median_wormlength_um ~ Plate_design + Treatment + (1|Strain) + (1|Strain:Treatment), data = cold24hrs_delta_df)
summary(lm_24hrs)
anova(lm_24hrs)

#Likelihood ratio test to see if strain and strain*treatment terms are significant
lrt_24hrs <- lmerTest::ranova(lm_24hrs)
lrt_24hrs

#Adjust p-values by dividing by 2 because when testing the effect of a random effect the null model has a variance of 0. 
lrt_24hrs_strain_padj <- (lrt_24hrs$`Pr(>Chisq)`[2])/2
lrt_24hrs_strain_padj

lrt_24hrs_strain_treatment_padj <- (lrt_24hrs$`Pr(>Chisq)`[3])/2
lrt_24hrs_strain_treatment_padj


#Calculate heritability 
vc_24hrs <- as.data.frame(lme4::VarCorr(lm_24hrs), comp = c("Variance"))
strain_treatment_variance_24hrs <- vc_24hrs$vcov[vc_24hrs$grp == "Strain:Treatment"]
strain_variance_24hrs <- vc_24hrs$vcov[vc_24hrs$grp == "Strain"]
residual_variance_24hrs <- vc_24hrs$vcov[vc_24hrs$grp == "Residual"]

H2_strain_24hrs <- strain_variance_24hrs/(strain_variance_24hrs + residual_variance_24hrs + strain_treatment_variance_24hrs)
H2_strain_24hrs

H2_strain_treatment_24hrs <- strain_treatment_variance_24hrs/(strain_variance_24hrs + residual_variance_24hrs + strain_treatment_variance_24hrs)
H2_strain_treatment_24hrs
```



Delta box plots
```{r}
#Make dataframe
treatment24hrs_df <- cold24hrs_delta_df %>%
  dplyr::filter(Treatment == "treatment")


#Box plot
treatment24_delta_plot <- ggplot(treatment24hrs_df, aes(x = Strain, y = median_wormlength_um_delta)) + 
  ggplot2::geom_boxplot(outlier.shape = NA) +
  #geom_violin() +
  ggplot2::geom_jitter(shape=16, position=position_jitter(0.2), size = 1, alpha = 0.5) + 
  ggplot2::xlab("Strain") + 
  ggplot2::ylab("Treatment - Control\nAnimal Length (µm)") +
  ggplot2::theme_classic() + 
  ggplot2::coord_cartesian(clip = "off") + 
  ggplot2::theme(
    axis.title.y = element_text(size = 10), 
    axis.title.x = element_text(size = 10), 
    axis.text.x = element_text(size = 8)
  )+
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0.05, 0.1)))
  
treatment24_delta_plot

```


Rxn norm for length
```{r}
#create strain mean dataframe
rxn_df_24hrs <- cold24hrs_delta_df %>% 
  dplyr::select(Treatment, Strain, median_wormlength_um) %>%
  dplyr::group_by(Strain, Treatment) %>% 
    dplyr::summarise(
      wormlength_strain_mean = mean(median_wormlength_um, na.rm = TRUE)) %>% 
  dplyr::mutate(contidition_numeric = case_when(
    Treatment == "control" ~ 1, 
    Treatment == "treatment" ~ 2
  ))

#Create heritabiliity dataframes so that heritability can be added to plots
H2_strain_24hrs_plot_df <- data.frame(
  x = 1.5,
  y = max(rxn_df_24hrs$wormlength_strain_mean) + 40,
  label = I(list(bquote(italic({H^2}[strain]) == .(round(H2_strain_24hrs, digits = 2))))))

H2_strain_treatment_24hrs_plot_df <- data.frame(
  x = 1.5,
  y = max(rxn_df_24hrs$wormlength_strain_mean) + 20,
  label = I(list(bquote(italic({H^2}[strain~":"~treatment]) == .(round(H2_strain_treatment_24hrs, digits = 2))))))


#make rxn norm plot
rxn_plot_24hrs <- ggplot(rxn_df_24hrs, aes(x = contidition_numeric, y=wormlength_strain_mean)) + 
  ggplot2::geom_line(aes(group=Strain)) + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_continuous(breaks = c(1,2), 
                     limits = c(1,2), 
                     labels = c("20°C", "4°C")) + 
  ggplot2::geom_text(data = H2_strain_24hrs_plot_df, 
            aes(x = x, y = y, label = label), 
            parse = TRUE, 
            size = 3.5)  + 
  ggplot2::geom_text(data = H2_strain_treatment_24hrs_plot_df, 
            aes(x = x, y = y, label = label), 
            parse = TRUE, 
            size = 3.5)  + 
  ggplot2::xlab("L1 Larval Stage Temperature") + 
  ggplot2::ylab("Mean Animal Length (µm)") +
  ggplot2::theme_classic() + 
  ggplot2::theme(
    axis.title.y = element_text(size = 10), 
    axis.title.x = element_text(size = 10), 
    axis.text.x = element_text(size = 8)
  )

rxn_plot_24hrs
```


merge 24 hour plots together to make panel
```{r}
Fig1_panelB <- cowplot::plot_grid(treatment24_delta_plot,
                                       rxn_plot_24hrs, rel_widths = c(3, 2))

Fig1_panelB <- ggdraw(Fig1_panelB) + draw_label("24-hour cold treatment", 
                                                fontface = 'bold', 
                                                x = 0.5, 
                                                y = 0.95,
                                                size = 12)

Fig1_panelB
```


## combine all panels to make figure 1 
NOTE: did not include 1 week cold treatment in manuscript because the treatment was too harsh and most of the variation likely came from the 1 week L1 starvation rather than the cold treatment. 

```{r}
#Make figure 
Figure1 <- ggpubr::ggarrange(Fig1_panelA , 
                     Fig1_panelB, 
                     ncol = 1, 
                     labels = c("A", "B"),
                     font.label = list(size = 12, color = "black", face = "bold"))
Figure1

#Export based on micropub guidelines: .jpg 500 DPI with 4:3 aspect ratio 
ggsave(filename = "C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/plots/micropub_figure1.jpg", plot = Figure1, dpi = 500, width = 8, height = 6)

```


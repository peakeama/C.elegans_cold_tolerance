---
title: "easyXpress 24 hours cold trial"
author: "Amanda Peake"
date: "2024-12-17"
output: html_document
editor_options: 
  chunk_output_type: console
---

# R version and packages needed
```{r, include=FALSE}
R.Version()$version.string

#easyXpress
#devtools::install_github("AndersenLab/easyXpress")
library(easyXpress)
library(tidyverse)
library(ggplot2)
library(agricolae)
library(lme4)
library(dplyr)
library(caret)
```


## Load data
```{r, collapse=TRUE}
#Read in data 
cold_24hrs_data <- easyXpress::readXpress(filedir = "C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/ImageXpress_assays/24hrscold/24hrscold/Analysis-20241202",
                                          rdafile = "NA_Analysis-20241202.RData",
                                          design = TRUE, 
                                          doseR = FALSE
                                          )


#model selection
ms <- easyXpress::modelSelection(cold_24hrs_data$raw_data)

```


## Flag objects
```{r}
#flag objects that are close to the edge of the well that are difficult to segment properly
ef <- edgeOF(data = ms)

#flag objects that are found within the same primary object which are often debris or improperly segmented worms
cf <- clusterOF(data = ef)


```

Check proportion of flags in each plate
```{r, collapse=TRUE}
#Check flags
c1 <- checkOF(data = cf, strain, notes)
c1$p
```

Check distribution of object length for each plate
```{r, collapse=TRUE}
#visualize size distribution of the ojbect by grouping variables
c2 <- checkObjs(data = cf, OF = "filter", strain, notes)
c2

```

Check if small objects are debris
```{r}
#Add variables that describe the PATH to processed images and well labels
cm <- cf %>%
  dplyr::mutate(i.dir = dplyr::case_when(Metadata_Experiment == "cold24hrs" ~ "C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/ImageXpress_assays/24hrscold/24hrscold/Analysis-20241202/processed_images/processed_images/", 
                                         TRUE ~ NA_character_), 
                w.lab = paste(Metadata_Plate, strain, sep = "_"))

#Check models 
#cm.out <- checkModels(data = cm, 
#                      Metadata_Experiment, Metadata_Plate, 
#                      proc.img.dir = "i.dir", 
#                     well.label = "w.lab", 
#                       out.dir = "C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/ImageXpress_assays/24hrscold/24hrscold/Analysis-20241202/checkModels/out/")
#
#
```

Remove objects less than 100um and MDHD 
```{r, collapse=TRUE}
#add the user variable that will be converted into a flag
u = cm %>%
  dplyr::mutate(user = dplyr::case_when(worm_length_um < 165 ~ "junk",
                                        model == "MDHD" ~ "junk",
                                        #strain == "QX1211" ~ "junk", #QX1211 wells did not have any worms in them
                                        TRUE ~ NA_character_))

#specify user variable as the flag 
uf <- easyXpress::userOF(data= u, user)

#check data again
checkObjs(data = uf, OF = "filter", strain, notes)

```


Flag objects with extreme worm values
```{r, collapse=TRUE}
#flags objects with extremely large worm_length-um values
o <- easyXpress::outlierOF(data = uf)

#check objects
checkObjs(data = o, OF = 'filter', strain, notes)

#check propotion of flags
co2 <- checkOF(data = o, strain, notes)
co2
```

View wells to see what data is worth keeping
```{r, collapse=TRUE}
##set seed to select 8 random flagged well with flags
#set.seed(99)
#
##set the flags and filter data
#o2 <- easyXpress::setOF(data = o) %>%
#  #randomly sample 8 wells
#  dplyr::filter(well.id %in% sample(well.id, size = 8))
#
##make overlay
# vo1 <- easyXpress::viewOverlay(data = o2,
#                         proc.img.dir = "i.dir",
#                         well.label = "w.lab",
#                         obj.label = "model",
#                         text.anno = "objectFlag",
#                         # save to example dir
#                         file = "C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/ImageXpress_assays/24hrscold/24hrscold/Analysis-20241202/viewOverlay/overlay.png")
```

remove all flagged object from the data
```{r, collapse=TRUE}
#processed object dataset
proc.objs <- easyXpress::filterOF(o, rmVars = TRUE)
```

## Flag wells

NOTE: did not check for variation between bleaches because all measurements were taken from the same bleach prep. 

Remove flagged objects, summarize data within each well and drop all object related variables from the data to prepare for flagging wells. 
```{r, collapse=TRUE}
raw.wells <- easyXpress::summarizeWells(data = o)
```

Flag wells that have too many or too few objects in them
```{r, collapse=TRUE}
#Make a tf dataframe 
tf <- easyXpress::titerWF(data = raw.wells,
                          Metadata_Experiment, bleach, strain, replicate,
                          doseR = FALSE)

tf$p

#check the number of objects in each well
n <- easyXpress::nWF(data = tf$d, strain, notes, max = 60, min = 5)
n$p

#flag wells with extreme outlier values
ow <- easyXpress::outlierWF(data = n$d, 
                            Metadata_Experiment, strain, replicate, notes)

#check flagged outlier wells by control vs treatment
cw1 <- easyXpress::checkWF(data = ow, strain, notes)
cw1$p

#check flagged outlier wells be plate
cw2 <- easyXpress::checkWF(data = ow, strain, replicate)
cw2$p
```


Remove all flagged wells from the data
NOTE: removed QX1211 because of low embryo yield during filtration.
```{r, collapse=TRUE}
#remove wells
fw <- filterWF(data = ow, rmVars = TRUE)

#check balance to see fraction retained after flags are filtered
cb <- checkBalance(data = fw, strain, notes, 
                   design = cold_24hrs_data$design, 
                   x = replicate)
cb$p

#remove QX1211 
drop <- fw %>%
  dplyr::mutate(b.filter =
                  dplyr::case_when(strain == "QX1211" ~  "drop",
                                   TRUE ~ "keep")) %>%
  dplyr::filter(b.filter == "keep") %>%
  dplyr::select(-b.filter)


#check data after removing problematic strains or plates
ce1 <- easyXpress::checkEff(data = drop, strain, 
                            x = notes, 
                            y = median_wormlength_um, 
                            fill = replicate, 
                            scales = "free_x"
                           )
ce1

```


## Finalize results

Calculate difference between control and treatment. delta() calculates the difference in well summary statistics between the experimental condition and the median control condition within a group. 
```{r, collapse=TRUE}
#Calculate difference between control wells and treatment
del <- easyXpress::delta(data = drop, 
                         replicate, strain, 
                         WF = "filter", 
                        vars = c("median_wormlength_um"),
                         doseR = FALSE)


#Select columns needed for final dataframe 
finalized_delta_df <- del %>%
  dplyr::select(-drug, -concentration_um, -drug_prep_method, -i.dir, -flag_id, -Metadata_Group, -wo_po_area_frac, -assay_type, -food_conc_OD, -food_type, -diluent, -bleach, -well_censor, -well_censor_reason) %>%
  dplyr::rename("well ID" = well.id, 
                "Experiment" = Metadata_Experiment, 
                "Plate" = Metadata_Plate, 
                "Well" = Metadata_Well, 
                "Date" = Metadata_Date, 
                "Magnification" = Metadata_Magnification, 
                "Image" = FileName_RawBF, 
                "Strain" = strain, 
                "Treatment" = notes, 
                "Plate Design" = replicate, 
                "Well Strain" = w.lab, 
                "Mean wormlength (µm)" = mean_wormlength_um, 
                "Minimum wormlength (µm)" = min_wormlength_um, 
                "q10 wormlength (µm)" = q10_wormlength_um, 
                "q25 wormlength (µm)" = q25_wormlength_um, 
                "Median wormlength (µm)" = median_wormlength_um, 
                "Standard Deviation wormlength (µm)" = sd_wormlength_um, 
                "q75 wormlength (µm)" = q75_wormlength_um, 
                "q90 wormlength (µm)" = q90_wormlength_um, 
                "Maximum wormlength (µm)" = max_wormlength_um, 
                "Coefficient of variation wormlength (µm)" = cv_wormlength_um, 
                "Number of worms" = n, 
                "Control median wormlength (µm)" = control_median_wormlength_um, 
                "Delta median wormlength (µm)" = median_wormlength_um_delta
                )


#write del to csv to be used in manuscript visualisation script
write.csv(finalized_delta_df, file = "C:/Users/amand/OneDrive - University of Toronto/Documents/Academics/PhD/Cold_worms/24hours_manuscript_df.csv", row.names = FALSE)

```






Account for differences between replicates
```{r, collapse=TRUE}
#regress the effect of independent plates (eg. blocks) for each strain
#drop$replicate <- as.character(drop$replicate)

#reg <- easyXpress::regEff(data = drop, notes, 
#                          c.var = replicate
#                          d.var = median_wormlength_um, #dependent variable
#                          )
#
#reg$p2
```


Calculate difference between control and treatment. delta() calculates the difference in well summary statistics between the experimental condition and the median control condition within a group. 
```{r, collapse=TRUE}
#Calculate difference
#del <- easyXpress::delta(data = reg$d, 
#                         replicate, strain, 
#                         WF = "filter", 
#                        vars = c("median_wormlength_um_reg"),
#                         doseR = FALSE)
#
#
##write del to csv to be used in manuscript visualisation script
#write.csv(del, file = "C:/Users/amand/OneDrive - University of #Toronto/Documents/Academics/PhD/Cold_worms/24hours_delta_df.csv", row.names = FALSE)

```


Make a dataframe to compare treatment deltas
```{r}
##Make dataframe
#treatment_df <- subset(del, del$notes == "treatment")
#
###anova
#strain_annova <- aov(median_wormlength_um_reg_delta ~ strain + replicate, data = treatment_df)
#summary(strain_annova)
#
#
##Tukey HSD 
#strain_tukey <- HSD.test(strain_annova, trt = "strain")
#strain_tukey
```


Calculate broad sense heritability

Heritability = 3589.2/(3589.2 + 1835.6) = 0.6616281
```{r}
##mixed model 
#H_strain_model <- lmer(median_wormlength_um_reg_delta ~ (1|strain), data = treatment_df)
#summary(H_strain_model)
#vc <- VarCorr(H_strain_model)
#print(vc,comp=c("Variance"))
#
#
```


Make a box plot to compare median deltas 

```{r}
##Set order of strains based on sampling latitude 
#treatment_df$strain <- factor(treatment_df$strain, levels = c("ECA1286", "DL238", "CB4856", "CX11314", "JU394", "N2", #"JU1200"), ordered = TRUE)
#
##Make dataframe for tukey groupings for the plot 
#plot_tukey_groups <- merge(strain_tukey$means, strain_tukey$groups, by = "row.names")
#
#
##Box plot comparing median deltas for each strain
#treatment_delta_plot <- ggplot(treatment_df, aes(x = strain, y = median_wormlength_um_reg_delta)) + 
#  geom_boxplot(outlier.shape = NA) +
#  #geom_violin() +
#  geom_jitter(shape=16, position=position_jitter(0.2), aes(color = replicate)) + 
#  ggtitle("B) 24 hrs at 4°C") + 
#  xlab("strain ordered by latitude") + 
#  ylab("Δ median length per well") +
#  theme_classic() + 
#  theme(plot.title = element_text(size=16, face = "bold")) + 
#  geom_text(data=plot_tukey_groups, aes(x= Row.names, y = Q75, label = groups), size =5, vjust = -1.5, hjust =-1)
#  
#treatment_delta_plot
#
##Box plot not colored by replicates
#treatment_delta_plot <- ggplot(treatment_df, aes(x = strain, y = median_wormlength_um_reg_delta)) + 
#  geom_boxplot(outlier.shape = NA) +
#  #geom_violin() +
#  geom_jitter(shape=16, position=position_jitter(0.2)) + 
#  ggtitle("B) 24 hrs at 4°C") + 
#  xlab("strain ordered by latitude") + 
#  ylab("Δ median length per well") +
#  theme_classic() + 
#  theme(plot.title = element_text(size=16, face = "bold")) + 
#  geom_text(data=plot_tukey_groups, aes(x= Row.names, y = Q75, label = groups), size =5, vjust = -2, hjust =-1, color = #"blue")
#  
#treatment_delta_plot
```



## Visualize for control distribution
```{r}
### Visualize for control distribution
##make control dataframe
#control_df <- del %>%
#  dplyr::filter(notes == "control")
#
##make a dataframe of means for all strains in the control treatment
#control_means_df <- control_df %>%
#  group_by(strain) %>%
#  summarise(wormlength_mean_control = mean(median_wormlength_um, na.rm = TRUE))
```


Plot control distribution
```{r}
##make box plot of control plates
#control_distribution_plot <- ggplot(control_df, aes(x = reorder(strain, median_wormlength_um, FUN = median) , y = #median_wormlength_um)) + 
#  geom_boxplot(outlier.shape = NA) +
#  #geom_violin() +
#  geom_jitter(shape=16, position=position_jitter(0.2), size = 1) + 
#  ggtitle("Control Phenotypic distribution elegans 24hrs cold treatment") + 
#  xlab("strain") + 
#  ylab("median length per well") +
#  theme_classic() + 
#  theme(plot.title = element_text(size=16, face = "bold")) + 
#  theme(legend.position="none",
#        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
#
#control_distribution_plot
```







